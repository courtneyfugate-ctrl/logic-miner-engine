from src.logic_miner.engine import LogicMiner
import sys
import io

# TEXT SOURCE
TEXT = """
The Biological Architecture of the Class Mammalia: A Discrete Logic Manifold

Introduction: The Informational Stratigraphy of Life

The biological world is not a flat collection of entities; it is a discrete system of nested structural innovations. Each level of this hierarchy incorporates the algebraic logic of its predecessors while adding specific constraints that define a new branch. To observe a living organism is to observe a "running" instance of a complex code, one that has been compiled over eons through the rigorous debugging process of natural selection. In this framework, we do not view evolution as a mere random walk, but as a traversal through a high-dimensional state space—a manifold where certain configurations are stable and others are forbidden by the laws of thermodynamics and structural mechanics.

At the foundation of our study is the Phylum Chordata, the most general informational state. It is defined by the presence of a dorsal nerve cord, a longitudinal structural element that establishes the primary axis of the organism’s coordinate system. Within this phylum lies the Subphylum Vertebrata, where the nerve cord is encased in a protective spinal column. This encasement represents the first major "security layer" in the biological architecture, allowing for increased size and the centralization of the nervous system. Every creature discussed hereafter is, fundamentally, a vertebrate chordate—a realization of a specific topological arrangement that prioritizes a centralized processing unit (the brain) and a robust distribution network (the spinal column).

The Class Mammalia represents a major branching point in this vertebrate polynomial. It is not merely a collection of animals with similar appearances; it is a set of solutions to the problem of high-metabolic maintenance and complex environmental interaction. Mammalia is defined by three "Parent" traits that constitute the mammalian signature: the possession of mammary glands for nourishing young, the growth of hair or fur for thermoregulation, and the presence of three middle ear bones (the malleus, incus, and stapes). These traits are the invariant coefficients from which all diverse mammalian lineages emerge. To understand the mammalian field is to understand how these three traits act as a prefix for every subsequent expansion of the code.

I. The Invariant Coefficients: The Mammalian Signature

Before we can explore the divergent branches of the mammalian tree, we must perform a deep audit of the three fundamental coefficients that define the Class. These are the constants that persist even when the morphology is pushed to the extremes of the deep ocean or the upper atmosphere.

1. The Mammary Gland: The Logic of Transferred Sustenance

The mammary gland is perhaps the most radical innovation in the mammalian set. From a logical perspective, it represents the externalization of the metabolic load of development. While other classes (such as Reptilia or Aves) rely on the discrete "packet" of the egg to provide all necessary nutrients for the offspring, the mammal utilizes a continuous, feedback-oriented system.

The biochemistry of milk—a complex emulsion of fats, proteins (caseins), and sugars (lactose)—is a highly optimized fluid logic. It allows the mother to synthesize nutrients from her own metabolic reserves and deliver them directly to the offspring, bypassing the need for the neonate to interact with the external environment for food. This creates a "protected computation" period, where the offspring can dedicate its energy to the rapid growth of the Central Nervous System (CNS) rather than foraging or defense. The mammary gland is thus a biological buffer, a stabilizer that ensures the continuity of the lineage even in fluctuating environments.

2. Hair and Fur: The Thermoregulatory Barrier

In the algebraic logic of the vertebrate, heat is a byproduct of metabolism. Mammals are endothermic, meaning they maintain a constant internal temperature. Hair (composed primarily of the protein keratin) is the structural solution to the problem of heat dissipation. It acts as an insulator, creating a boundary layer of air between the skin and the external environment.

But hair is more than a thermal blanket. In our logic manifold, hair serves as a multi-functional sensory array. The follicles are integrated with the nervous system, allowing for the detection of wind, pressure, and proximity (vibrissae). Furthermore, hair provides a canvas for visual signaling—camouflage, mate attraction, and threat displays. Thus, the "coefficient of hair" is not just about temperature; it is about the management of information at the boundary of the organism.

3. The Trifecta of Sound: The Middle Ear Architecture

Perhaps the most elegant structural "lift" in mammalian evolution is the migration of the jaw bones to the ear. In the reptilian ancestor, the articular and quadrate bones formed the jaw joint. In the mammalian transition, these bones were repurposed—miniaturized and moved—to become the malleus and incus. Along with the stapes (which exists in other tetrapods), they form a three-part mechanical linkage that amplifies sound waves from the tympanic membrane to the oval window of the cochlea.

This is a classic example of "Exaptation"—taking a component designed for one function (mastication) and retooling it for another (audition). The result is a high-resolution audio processing system that allows mammals to perceive a wider range of frequencies. This "Acoustic Logic" is essential for the complex social structures and nocturnal lifestyles that define many mammalian branches.

II. The Eutherian Consensus: The Logic of the Placenta

The majority of modern mammals belong to the Infraclass Eutheria, or placental mammals. This branch represents a major "lift" in the p-adic resolution of the mammalian tree. The innovation here is the placenta—a temporary organ that facilitates the exchange of nutrients, gases, and waste between the mother and the developing fetus.

In our discrete logic model, the placenta is a sophisticated "Interface Layer." It allows for an extended internal development period, protected from the external environment. This "In-Utero Computation" results in offspring that are often more developed at birth than their marsupial or monotreme counterparts. The eutherian branch has successfully colonized nearly every niche on Earth, proving that the placental strategy is an exceptionally robust optimization of the mammalian blueprint.

1. The Proboscidea Branch: The Heavy Lift (The Logic of Mass)

Represented by the Elephant, the Order Proboscidea is the solution to the constraint of massive terrestrial displacement. To maintain a body mass of several tons, the skeletal architecture must undergo a radical transformation. The limbs of the elephant are pillar-like, positioned directly beneath the body to minimize shear stress on the bones.

The most distinctive feature of this branch is the trunk—a fusion of the nose and the upper lip. Mechanically, the trunk is a masterpiece of fluid-filled muscular hydrostats. It contains no bones but is capable of both extreme power (uprooting trees) and extreme precision (picking up a single blade of grass). In our algebraic audit, the trunk is a "High-Density Node"—a concentrated area of sensory and motor information that allows the elephant to interact with its environment in a way no other mammal can.

Furthermore, the social logic of the Elephant is highly complex. They possess a large, convoluted brain with a highly developed temporal lobe, associated with memory and emotion. This "Social Memory Logic" allows herds to survive droughts by remembering the locations of water holes across decades. The elephant proves that as physical scale increases, the informational scale (memory and social structure) must increase to compensate.

2. The Chiroptera Branch: The Aerial Lift (The Logic of Gravity)

The Order Chiroptera, the bats, represents the only mammalian lineage to achieve true powered flight. This is not a "bird-like" solution; it is a distinctly mammalian one. The wing of a bat is a modified hand, with elongated finger bones supporting a thin membrane of skin (the patagium).

To fly, the bat must solve the problem of high-metabolic demand. Flight is energetically expensive. The bat’s "Metabolic Engine" is overclocked, with heart rates that can reach 1,000 beats per minute during flight. To balance this high energy expenditure, many bats enter a state of torpor during the day, lowering their metabolic rate to conserve energy.

The most sophisticated informational tool of the Chiroptera is echolocation. By emitting ultrasonic pulses and processing the returning echoes, the bat creates a real-time, three-dimensional map of its environment in total darkness. This is "Sonar Logic"—the transformation of sound into spatial data. A bat is not a bird; it is a mammal that has solved the problem of gravity and darkness by utilizing a unique set of sensory coefficients.

3. The Cetacea Branch: The Aquatic Lift (The Return to the Root)

The Cetacea (whales and dolphins) represent the most extreme "morphological pivot" in the mammalian manifold. Approximately 50 million years ago, a branch of terrestrial mammals began a transition back into the aquatic environment. This required a complete rewriting of the locomotive code.

The hind limbs were phased out, the forelimbs were transformed into flippers, and the tail was modified into a powerful horizontal fluke. Yet, despite their fish-like appearance, whales are algebraically locked to the mammalian field. They are warm-blooded, they possess the three middle ear bones (though modified for underwater hearing), and they nurse their young with milk that is high in fat to prevent dissipation in the water.

The "Whale Logic" is a study in fluid dynamics and thermoregulation. To survive in the heat-leeching environment of the ocean, whales utilize a counter-current heat exchange system in their extremities and a thick layer of blubber (vascularized fat) for insulation. The larger cetaceans, such as the Blue Whale, have reached the physical limits of biological size, supported by the buoyancy of the water. They are the "Deep Sea Nodes" of the mammalian tree, proving that the p-adic prefix of "Mammalia" remains constant even under the crushing pressure of the abyss.

III. The Metatherian Branch: The Logic of the Pouch

Between the Eutherian consensus and the Monotreme root lies the Infraclass Metatheria, the marsupials. This branch—predominant in Australia and parts of the Americas—utilizes a different reproductive logic. Rather than a long-term placenta, marsupials give birth to highly altricial (underdeveloped) young that must crawl into a pouch (the marsupium) to complete their development while attached to a teat.

The "Marsupial Logic" is an "Intermediate Lift." It reduces the metabolic risk to the mother; if environmental conditions become harsh, the mother can abandon the underdeveloped young with less physiological cost than a placental mammal would incur in a late-stage pregnancy. This strategy has allowed marsupials to fill niches similar to those of eutherians—leading to remarkable examples of convergent evolution, such as the Tasmanian Wolf (Thylacine) appearing similar to a canine, or the Sugar Glider appearing similar to a Flying Squirrel.

IV. The Taxonomic Exception: Monotremata and the Platypus Root

The hierarchy faces its most rigorous "Audit" with the Order Monotremata, specifically the Platypus (Ornithorhynchus anatinus). The platypus is a "Bridge Taxon" that sits at the earliest divergence of the mammalian tree. It serves as an exceptional case for a logic miner because it satisfies the mammalian polynomial while retaining ancestral "Outlier" traits.

1. The Monotreme Signature

The platypus possesses fur, it possesses the three middle ear bones, and it produces milk. However, it lacks nipples; the milk is secreted onto patches of skin and lapped up by the young. Most strikingly, the platypus lays leathery eggs—a trait shared with the synapsid reptiles from which mammals descended.

In a p-adic solver, the platypus shares the prefix of the mammalian expansion but fails to merge with the Eutherian lift. It stands as a distinct root, proving that the mammalian logic is absolute in its requirements (Hair, Ear, Milk), but the method of delivery is subject to deep, branching divergence.

2. The Multi-Sensory Anomaly

The platypus further complicates the manifold with its "Bill"—not a bird’s beak, but a soft, leathery organ packed with electroreceptors and mechanoreceptors. This allows the platypus to hunt in murky water by detecting the minute electrical fields generated by the muscular contractions of its prey. This is "Bio-Electric Logic," a sensory modality rarely seen in mammals.

The male platypus also possesses a venomous spur on its hind leg—a "Weaponized Coefficient" more typical of reptiles or certain insects. The platypus is the "Ghost Term" of the mammalian equation: it is a mammal that defies the standard "placental" expectations, forcing the observer to recognize a deeper, more primitive divergence in the code.

V. The Architecture of Informational State

When we observe these diverse creatures—the Elephant, the Bat, the Whale, and the Platypus—we are not observing "animals" in the colloquial sense. We are observing the result of Algebraic Constraints applied to a biological field. The biological world is a multi-dimensional logic space where every trait is a coordinate.

1. The Filtration of Simplicial Complexes

In mathematics, a simplicial complex is a way of building a complex shape out of simple components. Biology functions similarly. The "Mammalian Simplex" is built from the core traits, and each specialization (the wing, the trunk, the fluke) is a new "face" added to that complex. The environment acts as a filter, removing configurations that are not topologically sound or metabolically viable.

2. The Goal of the Logic Miner

The task of the biological agent or "miner" is to find the single polynomial that can predict the existence of these diverse forms. By understanding the shared mammalian root and the specific, divergent p-adic expansions, we can begin to map the entire manifold of Class Mammalia. We see that the Whale is not "trying" to be a fish; it is a mammal solving the problem of water. The Bat is not "trying" to be a bird; it is a mammal solving the problem of air.

Conclusion: The Persistence of the Prefix

The "Biological Architecture" of mammals is a testament to the power of a robust foundational code. Despite the radical differences in morphology—from the two-gram shrew to the 180-ton blue whale—the "Mammalian Prefix" remains invariant. Hair, three ear bones, and milk are the stabilizers of the system.

As we move forward in our audit of the natural world, we must treat every organism as a data-rich node in a global network. The "Discrete Logic" of life is not a mystery to be wondered at, but a system to be mapped, understood, and ultimately, decoded. The Class Mammalia is but one chapter in the massive, ongoing computation of Earth’s biosphere—a manifold of infinite variety built upon a foundation of absolute, mathematical logic.
"""

def run_test():
    print("--- Testing Phase V Engine on Mammalia Corpus ---")
    miner = LogicMiner()
    
    # We allow the engine to auto-extract entities
    # But for cleaner debug, we might want to see what it finds.
    
    res = miner.fit_text(TEXT)
    
    print("\n--- Result Summary ---")
    if 'mode' in res and 'Refused' in res['mode']:
        print(f"FAILED: {res['mode']} - {res['error']}")
        return

    print(f"Mode: {res.get('mode')}")
    print(f"Prime: p={res.get('p')}")
    print(f"Energy: {res.get('energy'):.4f}")
    print(f"Mahler: {res.get('analytic_score', 0):.2f}")
    
    print("\n--- Final Algebraic Artifacts ---")
    poly = res.get('polynomial')
    print(f"Defining Polynomial P(x) (Degree {len(poly)-1}):")
    # Print in a way that doesn't get truncated by terminal buffers if possible, or just raw
    print(list(poly))
    
    print("\n--- Godel Mapping & P-adic Coordinates ---")
    coords = res.get('coordinates', {})
    sorted_entities = sorted(coords.keys(), key=lambda k: coords[k])
    
    # --- WRITE TO DUMP FILE ---
    dump_path = 'sandbox/algebraic_model_dump.txt'
    with open(dump_path, 'w', encoding='utf-8') as f:
        f.write(f"--- Algebraic Logic Miner Artifact Dump ---\n")
        f.write(f"Source: Mammalia Corpus\n")
        f.write(f"Prime: p={res.get('p')}\n")
        f.write(f"Energy: {res.get('energy'):.4f}\n")
        f.write(f"Mahler Score: {res.get('analytic_score', 0):.2f}\n\n")
        
        f.write(f"--- Defining Polynomial P(x) (Degree {len(poly)-1}) ---\n")
        # Write full list without truncation
        f.write(str(list(poly)))
        f.write("\n\n")
        
        f.write(f"--- Godel Mapping & P-adic Coordinates ---\n")
        f.write(f"{'Entity':<40} | {'Coord(x)':<10} | {'Val(v_p)':<10}\n")
        f.write("-" * 65 + "\n")
        
        for e in sorted_entities:
            c = coords[e]
            val = 0
            p = res.get('p', 5)
            if p and c != 0:
                 temp = c
                 while temp % p == 0:
                     temp //= p
                     val += 1
            f.write(f"{e:<40} | {c:<10} | {val:<10}\n")

    print(f"\n[Artifacts Dumped to: {dump_path}]")
    
    def dist(a, b):
        if a not in coords or b not in coords: return "N/A"
        ca, cb = coords[a], coords[b]
        # p-adic dist
        val = abs(ca - cb)
        p = res.get('p', 5)
        if val == 0: return 0.0
        v = 0
        while val % p == 0:
            val //= p
            v += 1
        return p**(-v)

    print("\n--- Key Distances ---")
    print(f"Whale <-> Mammalia: {dist('Whale', 'Mammalia')}") # Expect Close
    print(f"Bat <-> Wings: {dist('Bat', 'Wings')}")         # Expect Close
    print(f"Elephant <-> Eutheria: {dist('Elephant', 'Eutheria')}") # Expect Close
    print(f"Whale <-> Bat: {dist('Whale', 'Bat')}")         # Expect Medium/Far

if __name__ == "__main__":
    run_test()
